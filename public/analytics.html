<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Analytics - Social SEO Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-5xl mx-auto">
        <div class="mb-6">
            <a href="/" class="text-blue-600 hover:underline">&larr; Back to Dashboard</a>
        </div>
        
        <div id="loading" class="text-center text-gray-500">Loading analytics...</div>
        
        <div id="content" class="hidden space-y-6">
            <!-- Header Info -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h1 id="link-title" class="text-2xl font-bold text-gray-800 truncate">Link Title</h1>
                <p class="text-gray-500 mt-1">Original: <a id="original-url" href="#" target="_blank" class="text-blue-500 hover:underline">...</a></p>
                <div class="mt-4 flex gap-4 text-sm">
                    <div class="bg-blue-50 px-4 py-2 rounded">
                        <span class="block text-gray-500 uppercase text-xs font-bold">Total Clicks</span>
                        <span id="total-clicks" class="text-2xl font-bold text-blue-600">0</span>
                    </div>
                    <div class="bg-gray-50 px-4 py-2 rounded">
                        <span class="block text-gray-500 uppercase text-xs font-bold">Created</span>
                        <span id="created-at" class="text-gray-700 font-medium">...</span>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Platforms Chart -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-lg font-semibold mb-4">Platform Distribution</h2>
                    <canvas id="platformChart"></canvas>
                </div>
                
                <!-- Recent Activity Table -->
                <div class="bg-white p-6 rounded-lg shadow-md overflow-hidden">
                    <h2 class="text-lg font-semibold mb-4">Recent Activity</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 font-medium border-b">
                                <tr>
                                    <th class="px-4 py-2">Time</th>
                                    <th class="px-4 py-2">Platform</th>
                                    <th class="px-4 py-2">User Agent</th>
                                </tr>
                            </thead>
                            <tbody id="activity-log" class="divide-y">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        if (!linkId) {
            alert('No link ID provided');
            window.location.href = '/';
        }

        async function loadAnalytics() {
            try {
                const res = await fetch(`/api/links/${linkId}`);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                
                renderData(data);
            } catch (error) {
                console.error(error);
                document.getElementById('loading').textContent = 'Failed to load analytics.';
            }
        }

        function renderData(data) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Header
            document.getElementById('link-title').textContent = data.title || 'Untitled Link';
            document.getElementById('original-url').href = data.originalUrl;
            document.getElementById('original-url').textContent = data.originalUrl;
            document.getElementById('total-clicks').textContent = data.clicks;
            document.getElementById('created-at').textContent = new Date(data.createdAt).toLocaleDateString();

            // Platform Stats
            const platforms = {};
            data.analytics.forEach(entry => {
                const p = entry.platform || 'Unknown';
                platforms[p] = (platforms[p] || 0) + 1;
            });

            const ctx = document.getElementById('platformChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(platforms),
                    datasets: [{
                        data: Object.values(platforms),
                        backgroundColor: [
                            '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#6366f1'
                        ]
                    }]
                }
            });

            // Activity Log (Last 20)
            const tbody = document.getElementById('activity-log');
            data.analytics.slice(0, 20).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-gray-500">${new Date(entry.createdAt).toLocaleString()}</td>
                    <td class="px-4 py-2 font-medium">${entry.platform || 'Unknown'}</td>
                    <td class="px-4 py-2 text-gray-400 truncate max-w-xs" title="${entry.userAgent}">${entry.userAgent}</td>
                `;
                tbody.appendChild(row);
            });
        }

        loadAnalytics();
    </script>
</body>
</html>
